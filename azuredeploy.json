{
	"$schema" : "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion" : "1.0.0.0",
	"parameters" : {
		"newStorageAccountName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the new storage account created to store the VMs disks"
			}
		},
		"storageAccountType" : {
			"type" : "string",
			"allowedValues" : [
				"Standard_LRS",
				"Standard_GRS",
				"Standard_RAGRS",
				"Standard_ZRS",
				"Premium_LRS"
			],
			"metadata" : {
				"description" : "The type of the Storage Account created"
			},
			"defaultValue" : "Standard_LRS"
		},
		"location" : {
			"type" : "string",
			"allowedValues" : [
				"West US",
				"East US",
				"West Europe",
				"East Asia",
				"Southeast Asia"
			],
			"metadata" : {
				"description" : "The region to deploy the resources into"
			}
		},
		"virtualNetworkName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the Virtual Network to Create"
			},
			"defaultValue" : "labVNET"
		},
		"virtualNetworkAddressRange" : {
			"type" : "string",
			"metadata" : {
				"description" : "The address range of the new VNET in CIDR format"
			},
			"defaultValue" : "192.168.0.0/16"
		},
		"labSubnetName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the subnet created in the new VNET"
			},
			"defaultValue" : "labSubnet"
		},
		"labSubnet" : {
			"type" : "string",
			"metadata" : {
				"description" : "The address range of the subnet created in the new VNET"
			},
			"defaultValue" : "192.168.10.0/24"
		},
		"feSubnetName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the subnet created in the new VNET"
			},
			"defaultValue" : "feSubnet"
		},
		"feSubnet" : {
			"type" : "string",
			"metadata" : {
				"description" : "The address range of the subnet created in the new VNET"
			},
			"defaultValue" : "192.168.200.0/24"
		},
		"dnsServerName": {
			"type": "string",
			"metadata": {
				"description": "The name of the DNS Server"
			},
			"defaultValue": "DCDNS"
		},
		"dnsServerAddress": {
			"type": "string",
			"metadata": {
				"description": "The address of the DNS Server"
			},
			"defaultValue": "192.168.10.4"
		},
		"dcNICName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the NIC attached to the new VM"
			},
			"defaultValue" : "dcNIC"
		},
		"dcNICIPAddress" : {
			"type" : "string",
			"metadata" : {
				"description" : "The IP address of the new AD VM"
			},
			"defaultValue" : "192.168.10.4"
		},
		"publicIPAddressName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the public IP address used by the Load Balancer"
			},
			"defaultValue" : "dcPublicIP"
		},
		"publicIPAddressType" : {
			"type" : "string",
			"allowedValues" : [
				"Dynamic",
				"Static"
			],
			"metadata" : {
				"description" : "The type of the public IP address used by the Load Balancer"
			},
			"defaultValue" : "Dynamic"
		},
		"dcVMName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the VM created"
			},
			"defaultValue" : "DC"
		},
		"adminUsername" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the Administrator of the new VM and Domain"
			},
			"defaultValue" : "labAdmin"
		},
		"adminPassword" : {
			"type" : "securestring",
			"metadata" : {
				"description" : "The password forthe Administrator account of the new VM and Domain"
			}
		},
		"dcVMSize" : {
			"type" : "string",
			"allowedValues" : [
				"Standard_D1",
				"Standard_DS1",
				"Standard_D2",
				"Standard_DS2",
				"Standard_D3",
				"Standard_DS3",
				"Standard_D4",
				"Standard_DS4",
				"Standard_D11",
				"Standard_DS11",
				"Standard_D12",
				"Standard_DS12",
				"Standard_D13",
				"Standard_DS13",
				"Standard_D14",
				"Standard_DS14"
			],
			"metadata" : {
				"description" : "The size of the VM Created"
			},
			"defaultValue" : "Standard_DS2"
		},
		"imagePublisher" : {
			"type" : "string",
			"defaultValue" : "MicrosoftWindowsServer",
			"metadata" : {
				"description" : "Image Publisher"
			}
		},
		"imageOffer" : {
			"type" : "string",
			"defaultValue" : "WindowsServer",
			"metadata" : {
				"description" : "Image Offer"
			}
		},
		"imageSKU" : {
			"type" : "string",
			"defaultValue" : "2012-R2-Datacenter",
			"metadata" : {
				"description" : "Image SKU"
			}
		},
		"dcAvailabilitySetName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The name of the availability set that the AD VM is created in"
			},
			"defaultValue" : "dcAvailabilitySet"
		},
		"domainName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The FQDN of the AD Domain created "
			}
		},
		"dcDNSName" : {
			"type" : "string",
			"metadata" : {
				"description" : "The DNS prefix for the public IP address used by the Load Balancer"
			}
		},
		"RDPPort" : {
			"type" : "int",
			"metadata" : {
				"description" : "The public RDP port for the VM"
			},
			"defaultValue" : 3389
		},
		"assetLocation" : {
			"type" : "string",
			"metadata" : {
				"description" : "The location of resources such as templates and DSC modules that the script is dependent"
			},
			"defaultValue" : "https://raw.githubusercontent.com/KevinRemde/BuildARMLab/master/"
		}
	},
	"variables" : {
		"dcLBFE" : "LBFE",
		"dcLBBE" : "LBBE",
		"dcRDPNAT" : "dcRDP",
		"VnetID" : "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
		"labSubnetId" : "[concat(variables('VnetID'),'/subnets/',parameters('labSubnetName'))]",
		"feSubnetId" : "[concat(variables('VnetID'),'/subnets/',parameters('feSubnetName'))]",
		"dcNICId" : "[resourceId('Microsoft.Network/networkInterfaces',parameters('dcNICName'))]",
		"dcIPConfigID" : "[concat(variables('dcNICId'),'/ipConfigurations/ipconfig1')]",
		"dcLBName" : "dcLoadBalancer",
		"dcLBID" : "[resourceId('Microsoft.Network/loadBalancers',variables('dcLBName'))]",
		"dcLBFEConfigID" : "[concat(variables('dcLBID'),'/frontendIPConfigurations/',variables('dcLBFE'))]",
		"dcRDPNATRuleID" : "[concat(variables('dcLBID'),'/inboundNatRules/',variables('dcRDPNAT'))]",
		"dcBEAddressPoolID" : "[concat(variables('dcLBID'),'/backendAddressPools/',variables('dcLBBE'))]",
		"dcDataDisk" : "dcDataDisk",
		"dcDataDiskSize" : 1000,
		"vnetTemplateUri" : "[concat(parameters('assetLocation'),'vnet.json')]",
		"vnetwithDNSTemplateUri" : "[concat(parameters('assetLocation'),'vnet-with-dns-server.json')]",
		"dcModulesURL" : "[concat(parameters('assetLocation'),'CreateADPDC.ps1.zip')]",
		"dcConfigurationFunction" : "CreateADPDC.ps1\\CreateADPDC"
	},
	"resources" : [{
			"type" : "Microsoft.Storage/storageAccounts",
			"name" : "[parameters('newStorageAccountName')]",
			"apiVersion" : "2015-05-01-preview",
			"location" : "[parameters('location')]",
			"properties" : {
				"accountType" : "[parameters('storageAccountType')]"
			}
		}, {
			"apiVersion" : "2015-05-01-preview",
			"type" : "Microsoft.Network/publicIPAddresses",
			"name" : "[parameters('publicIPAddressName')]",
			"location" : "[parameters('location')]",
			"properties" : {
				"publicIPAllocationMethod" : "[parameters('publicIPAddressType')]",
				"dnsSettings" : {
					"domainNameLabel" : "[parameters('dcDNSName')]"
				}
			}
		}, {
			"type" : "Microsoft.Compute/availabilitySets",
			"name" : "[parameters('dcAvailabilitySetName')]",
			"apiVersion" : "2015-05-01-preview",
			"location" : "[parameters('location')]"
		}, {
			"name" : "VNet",
			"type" : "Microsoft.Resources/deployments",
			"apiVersion" : "2015-01-01",
			"properties" : {
				"mode" : "Incremental",
				"templateLink" : {
					"uri" : "[variables('vnetTemplateUri')]",
					"contentVersion" : "1.0.0.0"
				},
				"parameters" : {
					"location" : {
						"value" : "[parameters('location')]"
					},
					"virtualNetworkName" : {
						"value" : "[parameters('virtualNetworkName')]"
					},
					"virtualNetworkAddressRange" : {
						"value" : "[parameters('virtualNetworkAddressRange')]"
					},
					"subnet1Name" : {
						"value" : "[parameters('feSubnetName')]"
					},
					"subnet1Range" : {
						"value" : "[parameters('feSubnet')]"
					}
					"subnet2Name" : {
						"value" : "[parameters('labSubnetName')]"
					},
					"subnet2Range" : {
						"value" : "[parameters('labSubnet')]"
					},
					"dnsServerName": {
						"value": "[parameters('dnsServerName')]"
					},
					"dnsServerAddress": {
						"value": "[parameters('dnsServerAddress')]"
					}
				}
			}
		}, {
			"apiVersion" : "2015-05-01-preview",
			"name" : "[variables('dcLBName')]",
			"type" : "Microsoft.Network/loadBalancers",
			"location" : "[parameters('location')]",
			"dependsOn" : [
				"[resourceId('Microsoft.Network/publicIPAddresses',parameters('publicIPAddressName'))]"
			],
			"properties" : {
				"frontendIPConfigurations" : [{
						"name" : "[variables('dcLBFE')]",
						"properties" : {
							"publicIPAddress" : {
								"id" : "[resourceId('Microsoft.Network/publicIPAddresses',parameters('publicIPAddressName'))]"
							}
						}
					}
				],
				"backendAddressPools" : [{
						"name" : "[variables('dcLBBE')]"
					}
				],
				"inboundNatRules" : [{
						"name" : "[variables('dcRDPNAT')]",
						"properties" : {
							"frontendIPConfiguration" : {
								"id" : "[variables('dcLBFEConfigID')]"
							},
							"protocol" : "tcp",
							"frontendPort" : "[parameters('RDPPort')]",
							"backendPort" : 3389,
							"enableFloatingIP" : false
						}
					}
				]
			}
		}, {
			"name" : "[parameters('dcNICName')]",
			"type" : "Microsoft.Network/networkInterfaces",
			"location" : "[parameters('location')]",
			"dependsOn" : [
				"Microsoft.Resources/deployments/VNet",
				"[concat('Microsoft.Network/loadBalancers/',variables('dcLBName'))]"
			],
			"apiVersion" : "2015-05-01-preview",
			"properties" : {
				"ipConfigurations" : [{
						"name" : "ipconfig1",
						"properties" : {
							"privateIPAllocationMethod" : "Static",
							"privateIPAddress" : "[parameters('dcNICIPAddress')]",
							"subnet" : {
								"id" : "[variables('labSubnetId')]"
							},
							"loadBalancerBackendAddressPools" : [{
									"id" : "[variables('dcBEAddressPoolID')]"
								}
							],
							"loadBalancerInboundNatRules" : [{
									"id" : "[variables('dcRDPNATRuleID')]"
								}
							]
						}
					}
				]
			}
		}, {
			"apiVersion" : "2015-05-01-preview",
			"type" : "Microsoft.Compute/virtualMachines",
			"name" : "[parameters('dcVMName')]",
			"location" : "[parameters('location')]",
			"dependsOn" : [
				"[resourceId('Microsoft.Storage/storageAccounts',parameters('newStorageAccountName'))]",
				"[resourceId('Microsoft.Network/networkInterfaces',parameters('dcNICName'))]",
				"[resourceId('Microsoft.Compute/availabilitySets', parameters('dcAvailabilitySetName'))]",
				"[resourceId('Microsoft.Network/loadBalancers',variables('dcLBName'))]"
			],
			"properties" : {
				"hardwareProfile" : {
					"vmSize" : "[parameters('dcVMSize')]"
				},
				"availabilitySet" : {
					"id" : "[resourceId('Microsoft.Compute/availabilitySets', parameters('dcAvailabilitySetName'))]"
				},
				"osProfile" : {
					"computerName" : "[parameters('dcVMName')]",
					"adminUsername" : "[parameters('adminUsername')]",
					"adminPassword" : "[parameters('adminPassword')]"
				},
				"storageProfile" : {
					"imageReference" : {
						"publisher" : "[parameters('imagePublisher')]",
						"offer" : "[parameters('imageOffer')]",
						"sku" : "[parameters('imageSKU')]",
						"version" : "latest"
					},
					"osDisk" : {
						"name" : "osdisk",
						"vhd" : {
							"uri" : "[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/vhds/','osdisk.vhd')]"
						},
						"caching" : "ReadWrite",
						"createOption" : "FromImage"
					},
					"dataDisks" : [{
							"vhd" : {
								"uri" : "[concat('http://',parameters('newStorageAccountName'),'.blob.core.windows.net/vhds/', variables('dcDataDisk'),'-1.vhd')]"
							},
							"name" : "[concat(parameters('dcVMName'),'-data-disk1')]",
							"caching" : "None",
							"createOption" : "empty",
							"diskSizeGB" : "[variables('dcDataDiskSize')]",
							"lun" : 0
						}
					]
				},
				"networkProfile" : {
					"networkInterfaces" : [{
							"id" : "[resourceId('Microsoft.Network/networkInterfaces',parameters('dcNICName'))]"
						}
					]
				}
			},
			"resources" : [{
					"type" : "Microsoft.Compute/virtualMachines/extensions",
					"name" : "[concat(parameters('dcVMName'),'/CreateADForest')]",
					"apiVersion" : "2015-05-01-preview",
					"location" : "[parameters('location')]",
					"dependsOn" : [
						"[resourceId('Microsoft.Compute/virtualMachines', parameters('dcVMName'))]"
					],
					"properties" : {
						"publisher" : "Microsoft.Powershell",
						"type" : "DSC",
						"typeHandlerVersion" : "2.11",
						"autoUpgradeMinorVersion" : true,
						"settings" : {
							"ModulesUrl" : "[variables('dcModulesURL')]",
							"ConfigurationFunction" : "[variables('dcConfigurationFunction')]",
							"Properties" : {
								"DomainName" : "[parameters('domainName')]",
								"AdminCreds" : {
									"UserName" : "[parameters('adminUserName')]",
									"Password" : "PrivateSettingsRef:AdminPassword"
								}
							}
						},
						"protectedSettings" : {
							"Items" : {
								"AdminPassword" : "[parameters('adminPassword')]"
							}
						}
					}
				}
			]
		}, {
			"name" : "UpdateVNetDNS",
			"type" : "Microsoft.Resources/deployments",
			"apiVersion" : "2015-01-01",
			"dependsOn" : [
				"[concat('Microsoft.Compute/virtualMachines/', parameters('dcVMName'),'/extensions/CreateADForest')]"
			],
			"properties" : {
				"mode" : "Incremental",
				"templateLink" : {
					"uri" : "[variables('vnetwithDNSTemplateUri')]",
					"contentVersion" : "1.0.0.0"
				},
				"parameters" : {
					"location" : {
						"value" : "[parameters('location')]"
					},
					"virtualNetworkName" : {
						"value" : "[parameters('virtualNetworkName')]"
					},
					"virtualNetworkAddressRange" : {
						"value" : "[parameters('virtualNetworkAddressRange')]"
					},
					"subnetName" : {
						"value" : "[parameters('labSubnetName')]"
					},
					"subnetRange" : {
						"value" : "[parameters('labSubnet')]"
					},
					"DNSServerAddress" : {
						"value" : [
							"[parameters('dcNICIPAddress')]"
						]
					}
				}
			}
		}
	]
}
